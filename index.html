<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiba Tracker üê∂üí∞</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Shiba theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fef3c7; /* Light creamy yellow, like Shiba fur */
            color: #4a4a4a; /* Dark gray for text */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            align-items: center;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background-color: #fff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .header {
            color: #e67e22; /* Orange, like Shiba's nose/ears */
            font-weight: 700;
            font-size: 2.25rem; /* Larger title */
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .shiba-emoji {
            font-size: 2.5rem;
            line-height: 1;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #d35400; /* Darker orange */
            margin-bottom: 1rem;
            border-bottom: 2px solid #f0b27a; /* Light orange border */
            padding-bottom: 0.5rem;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #f0b27a;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-label {
            font-weight: 500;
            font-size: 1.1rem;
            color: #555;
        }
        .summary-value {
            font-weight: 600;
            font-size: 1.2rem;
        }
        .income-value {
            color: #27ae60; /* Green */
        }
        .expense-value {
            color: #e74c3c; /* Red */
        }
        .balance-value {
            color: #3498db; /* Blue */
            font-size: 1.4rem;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px dotted #e0e0e0;
            font-size: 0.95rem;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-detail-col {
            text-align: left;
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        .transaction-amount-col {
            font-weight: 600;
            text-align: right;
        }
        .call-to-action {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #ffe0b2; /* Lighter orange */
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .action-button {
            background-color: #f39c12; /* Bright orange */
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-top: 1rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .action-button:hover {
            background-color: #e67e22; /* Darker orange on hover */
        }
        .footer-text {
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: #777;
        }
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .radio-group input[type="radio"] {
            margin-right: 0.5rem;
        }
        .radio-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .submit-button {
            background-color: #2ecc71; /* Green for submit */
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 100%;
            margin-top: 1rem;
        }
        .submit-button:hover {
            background-color: #27ae60; /* Darker green on hover */
        }
        .message-box {
            background-color: #f0f8ff;
            border: 1px solid #a8d9ff;
            color: #31708f;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: left;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .message-box.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="header">
            <span class="shiba-emoji">üê∂</span> Shiba Tracker <span class="shiba-emoji">üí∞</span>
        </h1>

        <div class="message-box" id="messageBox"></div>

        <div class="mb-6">
            <h2 class="section-title">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ üóìÔ∏è</h2>
            <div class="summary-item">
                <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span class="summary-value income-value" id="monthly-income">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span class="summary-value expense-value" id="monthly-expense">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                <span class="summary-value balance-value" id="monthly-balance">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
        </div>

        <div class="mb-6">
            <h2 class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î üìù</h2>
            <div id="recent-transactions">
                <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
            </div>
        </div>

        <div class="mb-6">
            <h2 class="section-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà ‚ûï‚ûñ</h2>
            <form id="transactionForm" class="text-left">
                <div class="form-group">
                    <label for="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
                    <input type="number" id="amount" step="0.01" min="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 150.50" required class="focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="type" value="income" required checked> ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                        </label>
                        <label>
                            <input type="radio" name="type" value="expense"> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                    <select id="category" required class="focus:ring-orange-500 focus:border-orange-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                        <!-- Categories will be loaded dynamically here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):</label>
                    <input type="text" id="detail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏≤‡πÅ‡∏ü, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="focus:ring-orange-500 focus:border-orange-500">
                </div>
                <button type="submit" class="submit-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Æ‡∏±‡∏ö! ‚ú®</button>
            </form>
        </div>

        <div class="call-to-action">
            <p class="text-base font-medium">‡∏≠‡∏¢‡∏≤‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì/‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏´‡∏°‡∏Æ‡∏±‡∏ö?</p>
            <p class="text-sm text-gray-600 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üêæ</p>
            <button class="action-button" onclick="Telegram.WebApp.close()">‡∏õ‡∏¥‡∏î Mini App</button>
        </div>
    </div>

    <p class="footer-text">Powered by ‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞‡∏ö‡∏≠‡∏ó üê∂</p>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Initialize Telegram WebApp
        Telegram.WebApp.ready();

        const messageBox = document.getElementById('messageBox');
        const monthlyIncomeElem = document.getElementById('monthly-income');
        const monthlyExpenseElem = document.getElementById('monthly-expense');
        const monthlyBalanceElem = document.getElementById('monthly-balance');
        const recentTransactionsDiv = document.getElementById('recent-transactions');
        const transactionForm = document.getElementById('transactionForm');
        const amountInput = document.getElementById('amount');
        const typeInputs = document.querySelectorAll('input[name="type"]');
        const categorySelect = document.getElementById('category');
        const detailInput = document.getElementById('detail');

        let allCategories = { "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö": [], "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢": [] };

        // Function to show messages
        function showMessage(message, type = 'info') {
            messageBox.innerText = message;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // Function to render recent transactions
        function renderRecentTransactions(transactions) {
            recentTransactionsDiv.innerHTML = ''; // Clear previous transactions
            if (transactions.length === 0) {
                recentTransactionsDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòî</p>';
                return;
            }
            transactions.forEach(t => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'transaction-item';
                const typeEmoji = t.type === 'income' ? '‚ûï' : '‚ûñ';
                const amountColorClass = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                const formattedAmount = t.amount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const detailText = t.detail && t.detail !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' ? ` (${t.detail})` : '';
                const transactionDate = new Date(t.date);
                const timeString = transactionDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                itemDiv.innerHTML = `
                    <span class="${amountColorClass} mr-2">${typeEmoji}</span>
                    <span class="transaction-detail-col">${t.category}${detailText}</span>
                    <span class="text-gray-500 text-xs mr-2">${timeString}</span>
                    <span class="transaction-amount-col ${amountColorClass}">${formattedAmount} ‡∏ö‡∏≤‡∏ó</span>
                `;
                recentTransactionsDiv.appendChild(itemDiv);
            });
        }

        // Function to populate categories dropdown
        function populateCategories(selectedType) {
            categorySelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>'; // Reset
            const categories = allCategories[selectedType === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'];
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.innerText = cat;
                categorySelect.appendChild(option);
            });
        }

        // Handle type radio button change
        typeInputs.forEach(input => {
            input.addEventListener('change', (event) => {
                populateCategories(event.target.value);
            });
        });

        // Load initial data from start_param
        if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
            try {
                const decodedData = decodeURIComponent(Telegram.WebApp.initDataUnsafe.start_param);
                const initialData = JSON.parse(decodedData);

                // Update summary
                if (initialData.summary) {
                    monthlyIncomeElem.innerText = `${initialData.summary.income.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                    monthlyExpenseElem.innerText = `${initialData.summary.expense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                    monthlyBalanceElem.innerText = `${initialData.summary.balance.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                }

                // Render recent transactions
                if (initialData.recent_transactions) {
                    renderRecentTransactions(initialData.recent_transactions);
                }

                // Store and populate categories
                if (initialData.categories) {
                    allCategories = initialData.categories;
                    // Populate categories based on default selected type (income)
                    populateCategories('income');
                }

            } catch (e) {
                console.error("Error parsing start_param:", e);
                showMessage("‡∏Æ‡∏∑‡∏≠‡πÜ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Æ‡∏±‡∏ö! üò≠", 'error');
                // Fallback to dummy data or empty state if parsing fails
                monthlyIncomeElem.innerText = '0.00 ‡∏ö‡∏≤‡∏ó';
                monthlyExpenseElem.innerText = '0.00 ‡∏ö‡∏≤‡∏ó';
                monthlyBalanceElem.innerText = '0.00 ‡∏ö‡∏≤‡∏ó';
                recentTransactionsDiv.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏Æ‡∏±‡∏ö üòî</p>';
            }
        } else {
            // If no start_param, show empty/default state
            monthlyIncomeElem.innerText = '0.00 ‡∏ö‡∏≤‡∏ó';
            monthlyExpenseElem.innerText = '0.00 ‡∏ö‡∏≤‡∏ó';
            monthlyBalanceElem.innerText = '0.00 ‡∏ö‡∏≤‡∏ó';
            recentTransactionsDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòî</p>';
            showMessage("‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Æ‡∏±‡∏ö! ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Mini App ‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö ÔøΩ", 'info');
        }

        // Handle form submission
        transactionForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default form submission

            const amount = parseFloat(amountInput.value);
            const type = document.querySelector('input[name="type"]:checked').value;
            const category = categorySelect.value;
            const detail = detailInput.value.trim();

            if (isNaN(amount) || amount <= 0) {
                showMessage("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ü•∫", 'error');
                return;
            }
            if (!category) {
                showMessage("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! üìù", 'error');
                return;
            }

            const transactionData = {
                action: 'add_transaction',
                payload: {
                    amount: amount,
                    type: type,
                    category: category,
                    detail: detail || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
                    date: new Date().toISOString() // Current date/time in ISO format
                }
            };

            // Send data to the bot
            try {
                Telegram.WebApp.sendData(JSON.stringify(transactionData));
                showMessage("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Æ‡∏±‡∏ö! ‚ú®", 'success');
                // Optionally clear form
                transactionForm.reset();
                populateCategories('income'); // Reset category dropdown
            } catch (e) {
                console.error("Error sending data to bot:", e);
                showMessage("‡∏Æ‡∏∑‡∏≠‡πÜ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Æ‡∏±‡∏ö! üò≠", 'error');
            }
        });
    </script>
</body>
</html>