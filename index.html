<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiba Nubtung üê∂üí∞</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Shiba theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fef3c7; /* Light creamy yellow, like Shiba fur */
            color: #4a4a4a; /* Dark gray for text */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            align-items: center;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background-color: #fff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .header {
            color: #e67e22; /* Orange, like Shiba's nose/ears */
            font-weight: 700;
            font-size: 2.25rem; /* Larger title */
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .shiba-emoji {
            font-size: 2.5rem;
            line-height: 1;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #d35400; /* Darker orange */
            margin-bottom: 1rem;
            border-bottom: 2px solid #f0b27a; /* Light orange border */
            padding-bottom: 0.5rem;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #f0b27a;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-label {
            font-weight: 500;
            font-size: 1.1rem;
            color: #555;
        }
        .summary-value {
            font-weight: 600;
            font-size: 1.2rem;
        }
        .income-value {
            color: #27ae60; /* Green */
        }
        .expense-value {
            color: #e74c3c; /* Red */
        }
        .balance-value {
            color: #3498db; /* Blue */
            font-size: 1.4rem;
        }
        .transaction-item, .category-item, .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px dotted #e0e0e0;
            font-size: 0.95rem;
        }
        .transaction-item:last-child, .category-item:last-child, .budget-item:last-child {
            border-bottom: none;
        }
        .transaction-detail-col, .category-name-col {
            text-align: left;
            flex-grow: 1;
            margin-right: 0.5rem;
        }
        .transaction-amount-col, .budget-amount-col {
            font-weight: 600;
            text-align: right;
        }
        .call-to-action {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #ffe0b2; /* Lighter orange */
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .action-button {
            background-color: #f39c12; /* Bright orange */
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-top: 1rem;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .action-button:hover {
            background-color: #e67e22; /* Darker orange on hover */
        }
        .footer-text {
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: #777;
        }
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .type-buttons-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        .type-button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border: 2px solid transparent; /* Default transparent border */
        }
        .type-button.income {
            background-color: #2ecc71; /* Green */
            color: white;
        }
        .type-button.expense {
            background-color: #e74c3c; /* Red */
            color: white;
        }
        .type-button.selected {
            border-color: #f39c12; /* Orange border when selected */
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.5); /* Orange glow */
        }
        .submit-button {
            background-color: #2ecc71; /* Green for submit */
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 100%;
            margin-top: 1rem;
        }
        .submit-button:hover {
            background-color: #27ae60; /* Darker green on hover */
        }
        .message-box {
            background-color: #f0f8ff;
            border: 1px solid #a8d9ff;
            color: #31708f;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: left;
            display: none; /* Hidden by default */
        }
        .message-box.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .message-box.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        /* Page specific styles */
        .page {
            display: none; /* All pages hidden by default */
            width: 100%;
        }
        .page.active {
            display: block; /* Active page is shown */
        }
        .top-nav-buttons {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            background-color: #f0b27a; /* Light orange for nav bar */
            padding: 0.75rem;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .top-nav-button {
            flex: 1 1 auto; /* Allow buttons to grow and shrink */
            min-width: 100px; /* Minimum width for buttons */
            background-color: #e67e22; /* Orange */
            color: white;
            padding: 0.7rem 0.5rem; /* Reduced horizontal padding for more buttons */
            margin: 0.25rem; /* Small margin between buttons */
            border-radius: 0.75rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem; /* Smaller font size for more buttons */
        }
        .top-nav-button:hover {
            background-color: #d35400; /* Darker orange on hover */
            transform: translateY(-1px);
        }
        .top-nav-button.active {
            background-color: #d35400; /* Darker orange for active button */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .refresh-button {
            background-color: #3498db; /* Blue for refresh */
            color: white;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }
        .refresh-button:hover {
            background-color: #2980b9;
        }
        /* Debugging Info visibility */
        #debug-info {
            display: block !important; /* Force display for debugging */
            background-color: #f0f0f0;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="header">
            <span class="shiba-emoji">üê∂</span> Shiba Nubtung <span class="shiba-emoji">üí∞</span>
        </h1>

        <div class="message-box" id="messageBox"></div>
        
        <!-- Debugging Info -->
        <div id="debug-info" class="text-xs text-gray-400 mb-4">
            <p id="debug-start-param-status">Start Param Status: Not received</p>
            <p id="debug-data-parse-status">Data Parse Status: Pending</p>
        </div>

        <div class="top-nav-buttons">
            <button class="top-nav-button active" id="btn-add-transaction" onclick="showPage('add-transaction-page')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚ú®</button>
            <button class="top-nav-button" id="btn-summary-budget" onclick="showPage('summary-budget-page')">‡∏™‡∏£‡∏∏‡∏õ & ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì üìä</button>
            <button class="top-nav-button" id="btn-manage-categories" onclick="showPage('manage-categories-page')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà üè∑Ô∏è</button>
            <button class="top-nav-button" id="btn-set-budget" onclick="showPage('set-budget-page')">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì üéØ</button>
        </div>

        <!-- Add Transaction Page (Main view as per image) -->
        <div id="add-transaction-page" class="page active">
            <div class="mb-6">
                <h2 class="section-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà ‚ú®</h2>
                <form id="transactionForm" class="text-left">
                    <div class="form-group">
                        <label for="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label>
                        <input type="number" id="amount" step="0.01" min="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 150.75" required class="focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div class="form-group">
                        <label for="detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):</label>
                        <input type="text" id="detail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü" class="focus:ring-orange-500 focus:border-orange-500">
                    </div>
                    <div class="form-group">
                        <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                        <select id="category" required class="focus:ring-orange-500 focus:border-orange-500">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                            <!-- Categories will be loaded dynamically here -->
                        </select>
                    </div>
                    <div class="type-buttons-group">
                        <button type="button" class="type-button income selected" data-type="income">‚úÖ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                        <button type="button" class="type-button expense" data-type="expense">‚ùå ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
                    </div>
                    <button type="submit" class="submit-button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Æ‡∏±‡∏ö! ‚ú®</button>
                </form>
            </div>

            <div class="mb-6">
                <h2 class="section-title">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ üìä</h2>
                <div class="summary-item">
                    <span class="summary-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                    <span class="summary-value balance-value" id="current-balance-add-page">0.00 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                    <span class="summary-value income-value" id="current-income-add-page">0.00 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                    <span class="summary-value expense-value" id="current-expense-add-page">0.00 ‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üìú</h2>
                <div id="recent-transactions">
                    <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
                </div>
            </div>
        </div>

        <!-- Summary & Budget Page -->
        <div id="summary-budget-page" class="page">
            <h2 class="section-title">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üóìÔ∏è</h2>
            <div class="summary-item">
                <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span class="summary-value income-value" id="monthly-income-summary-page">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span class="summary-value expense-value" id="monthly-expense-summary-page">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                <span class="summary-value balance-value" id="monthly-balance-summary-page">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>

            <h2 class="section-title mt-6">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô üéØ</h2>
            <div id="current-budgets">
                <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòü</p>
            </div>
            <button class="refresh-button" onclick="Telegram.WebApp.close()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• üîÑ</button>
        </div>

        <!-- Manage Categories Page -->
        <div id="manage-categories-page" class="page">
            <h2 class="section-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà üè∑Ô∏è</h2>
            <form id="addCategoryForm" class="text-left">
                <div class="form-group">
                    <label for="newCategoryName">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà:</label>
                    <input type="text" id="newCategoryName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏°, ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©" required class="focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="type-buttons-group">
                    <button type="button" class="type-button income selected" data-type="income" id="newCatTypeIncome">‚úÖ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                    <button type="button" class="type-button expense" data-type="expense" id="newCatTypeExpense">‚ùå ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
                </div>
                <button type="submit" class="submit-button">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Æ‡∏±‡∏ö! ‚ú®</button>
            </form>

            <h2 class="section-title mt-6">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üìã</h2>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö:</h3>
            <div id="income-categories-list" class="text-left">
                <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:</h3>
            <div id="expense-categories-list" class="text-left">
                <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>
            </div>
            <button class="refresh-button" onclick="Telegram.WebApp.close()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• üîÑ</button>
        </div>

        <!-- Set Budget Page -->
        <div id="set-budget-page" class="page">
            <h2 class="section-title">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì üéØ</h2>
            <form id="setBudgetForm" class="text-left">
                <div class="form-group">
                    <label for="budgetCategorySelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:</label>
                    <select id="budgetCategorySelect" required class="focus:ring-orange-500 focus:border-orange-500">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                        <!-- Expense categories will be loaded dynamically here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="budgetAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏ö‡∏≤‡∏ó):</label>
                    <input type="number" id="budgetAmount" step="0.01" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5000" required class="focus:ring-orange-500 focus:border-orange-500">
                </div>
                <button type="submit" class="submit-button">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Æ‡∏±‡∏ö! ‚ú®</button>
            </form>

            <h2 class="section-title mt-6">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ üìã</h2>
            <div id="set-budgets-list">
                <p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòü</p>
            </div>
            <button class="refresh-button" onclick="Telegram.WebApp.close()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• üîÑ</button>
        </div>


        <div class="call-to-action">
            <p class="text-base font-medium">‡∏≠‡∏¢‡∏≤‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì/‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏´‡∏°‡∏Æ‡∏±‡∏ö?</p>
            <p class="text-sm text-gray-600 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üêæ</p>
            <button class="action-button" onclick="Telegram.WebApp.close()">‡∏õ‡∏¥‡∏î Mini App</button>
        </div>
    </div>

    <p class="footer-text">Powered by ‡∏ô‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏ö‡∏∞‡∏ö‡∏≠‡∏ó üê∂</p>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Initialize Telegram WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand(); // Expand the Mini App to full height

        const messageBox = document.getElementById('messageBox');
        const debugStartParamStatus = document.getElementById('debug-start-param-status');
        const debugDataParseStatus = document.getElementById('debug-data-parse-status');
        
        // Global variables to store data from the bot
        let appData = {}; 
        let userCategories = { "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö": [], "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢": [] };
        let selectedTransactionType = 'income'; // Default selected type for transaction form
        let selectedNewCategoryType = 'income'; // Default for add category form

        // Elements for Add Transaction Page (Dashboard)
        const monthlyIncomeElemAddPage = document.getElementById('current-income-add-page');
        const monthlyExpenseElemAddPage = document.getElementById('current-expense-add-page');
        const monthlyBalanceElemAddPage = document.getElementById('current-balance-add-page');
        const recentTransactionsDiv = document.getElementById('recent-transactions');
        const transactionForm = document.getElementById('transactionForm');
        const amountInput = document.getElementById('amount');
        const detailInput = document.getElementById('detail');
        const categorySelect = document.getElementById('category');
        const typeButtons = document.querySelectorAll('.type-button'); // For transaction form type selection

        // Elements for Summary & Budget Page
        const monthlyIncomeSummaryPage = document.getElementById('monthly-income-summary-page');
        const monthlyExpenseSummaryPage = document.getElementById('monthly-expense-summary-page');
        const monthlyBalanceSummaryPage = document.getElementById('monthly-balance-summary-page');
        const currentBudgetsDiv = document.getElementById('current-budgets');

        // Elements for Manage Categories Page
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const newCatTypeIncomeBtn = document.getElementById('newCatTypeIncome');
        const newCatTypeExpenseBtn = document.getElementById('newCatTypeExpense');
        const incomeCategoriesList = document.getElementById('income-categories-list');
        const expenseCategoriesList = document.getElementById('expense-categories-list');
        

        // Elements for Set Budget Page
        const setBudgetForm = document.getElementById('setBudgetForm');
        const budgetCategorySelect = document.getElementById('budgetCategorySelect');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const setBudgetsList = document.getElementById('set-budgets-list');


        // General Page and Navigation Elements
        const pages = document.querySelectorAll('.page');
        const topNavButtons = document.querySelectorAll('.top-nav-button');

        // Function to show/hide pages and update active nav button
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            topNavButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            document.getElementById(`btn-${pageId.replace('-page', '')}`).classList.add('active');
            
            // Logic to populate dropdowns/lists when navigating to specific pages
            if (pageId === 'add-transaction-page') {
                renderDashboard();
                populateCategories(selectedTransactionType);
            } else if (pageId === 'summary-budget-page') {
                renderSummaryAndBudgets();
            } else if (pageId === 'manage-categories-page') {
                renderManageCategories();
                // Reset add category form type buttons
                newCatTypeIncomeBtn.classList.add('selected');
                newCatTypeExpenseBtn.classList.remove('selected');
                selectedNewCategoryType = 'income';
                newCategoryNameInput.value = ''; // Clear input field
            } else if (pageId === 'set-budget-page') {
                renderSetBudgetPage();
                budgetAmountInput.value = ''; // Clear input field
            }
        }

        // Function to show messages (similar to Telegram.WebApp.showAlert but in-app)
        function showMessage(message, type = 'info') {
            messageBox.innerText = message;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // --- Render functions for each page/section ---

        // Renders data for the "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" (Add Transaction) page
        function renderDashboard() {
            console.log("renderDashboard called. appData:", appData);
            // Update summary section
            if (appData.summary) {
                monthlyBalanceElemAddPage.textContent = `${appData.summary.balance.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                if (appData.summary.balance < 0) {
                    monthlyBalanceElemAddPage.classList.add('expense-value'); // Use red for negative balance
                    monthlyBalanceElemAddPage.classList.remove('balance-value');
                } else {
                    monthlyBalanceElemAddPage.classList.remove('expense-value');
                    monthlyBalanceElemAddPage.classList.add('balance-value');
                }
                monthlyIncomeElemAddPage.textContent = `${appData.summary.income.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                monthlyExpenseElemAddPage.textContent = `${appData.summary.expense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
            } else {
                monthlyBalanceElemAddPage.textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
                monthlyIncomeElemAddPage.textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
                monthlyExpenseElemAddPage.textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
            }

            // Render recent transactions
            recentTransactionsDiv.innerHTML = ''; // Clear previous transactions
            if (appData.recent_transactions && appData.recent_transactions.length > 0) {
                appData.recent_transactions.forEach(t => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'transaction-item';
                    const typeEmoji = t.type === 'income' ? '‚ûï' : '‚ûñ';
                    const amountColorClass = t.type === 'income' ? 'income-value' : 'expense-value';
                    const formattedAmount = t.amount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const detailText = t.detail && t.detail !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' ? ` (${t.detail})` : '';
                    // Ensure date is handled correctly, it should already be an ISO string from Python
                    const transactionDate = new Date(t.date); 
                    const timeString = transactionDate.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                    itemDiv.innerHTML = `
                        <span class="${amountColorClass} mr-2">${typeEmoji}</span>
                        <span class="transaction-detail-col">${t.category}${detailText}</span>
                        <span class="text-gray-500 text-xs mr-2">${timeString}</span>
                        <span class="transaction-amount-col ${amountColorClass}">${formattedAmount} ‡∏ö‡∏≤‡∏ó</span>
                    `;
                    recentTransactionsDiv.appendChild(itemDiv);
                });
            } else {
                recentTransactionsDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòî</p>';
            }
        }

        // Renders data for the "‡∏™‡∏£‡∏∏‡∏õ & ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì" (Summary & Budget) page
        function renderSummaryAndBudgets() {
            console.log("renderSummaryAndBudgets called. appData:", appData);
            // Monthly Summary
            if (appData.summary) {
                monthlyIncomeSummaryPage.textContent = `${appData.summary.income.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                monthlyExpenseSummaryPage.textContent = `${appData.summary.expense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                monthlyBalanceSummaryPage.textContent = `${appData.summary.balance.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                if (appData.summary.balance < 0) {
                    monthlyBalanceSummaryPage.classList.add('expense-value');
                    monthlyBalanceSummaryPage.classList.remove('balance-value');
                } else {
                    monthlyBalanceSummaryPage.classList.remove('expense-value');
                    monthlyBalanceSummaryPage.classList.add('balance-value');
                }
            } else {
                monthlyIncomeSummaryPage.textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
                monthlyExpenseSummaryPage.textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
                monthlyBalanceSummaryPage.textContent = '0.00 ‡∏ö‡∏≤‡∏ó';
            }

            // Current Budgets
            currentBudgetsDiv.innerHTML = '';
            if (appData.budgets && Object.keys(appData.budgets).length > 0) {
                for (const category in appData.budgets) {
                    const budgetAmount = appData.budgets[category];
                    const budgetItemDiv = document.createElement('div');
                    budgetItemDiv.className = 'budget-item';
                    budgetItemDiv.innerHTML = `
                        <span class="category-name-col font-medium">${category}:</span>
                        <span class="budget-amount-col">${budgetAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó</span>
                    `;
                    currentBudgetsDiv.appendChild(budgetItemDiv);
                }
            } else {
                currentBudgetsDiv.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòü</p>';
            }
        }

        // Renders data for the "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" (Manage Categories) page
        function renderManageCategories() {
            console.log("renderManageCategories called. userCategories:", userCategories);
            incomeCategoriesList.innerHTML = '';
            expenseCategoriesList.innerHTML = '';

            if (userCategories["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö"] && userCategories["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö"].length > 0) {
                userCategories["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö"].forEach(cat => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'category-item';
                    itemDiv.innerHTML = `<span class="category-name-col">${cat}</span>`;
                    incomeCategoriesList.appendChild(itemDiv);
                });
            } else {
                incomeCategoriesList.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>';
            }

            if (userCategories["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢"] && userCategories["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢"].length > 0) {
                userCategories["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢"].forEach(cat => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'category-item';
                    itemDiv.innerHTML = `<span class="category-name-col">${cat}</span>`;
                    expenseCategoriesList.appendChild(itemDiv);
                });
            } else {
                expenseCategoriesList.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>';
            }
        }

        // Renders data for the "‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì" (Set Budget) page
        function renderSetBudgetPage() {
            console.log("renderSetBudgetPage called. userCategories:", userCategories, "appData.budgets:", appData.budgets);
            // Populate budget category select with expense categories
            budgetCategorySelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>';
            const expenseCategories = userCategories['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'];
            if (expenseCategories && expenseCategories.length > 0) {
                expenseCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    budgetCategorySelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢';
                budgetCategorySelect.appendChild(option);
            }

            // Display current set budgets in this section (similar to currentBudgetsDiv but specific to this page)
            setBudgetsList.innerHTML = '';
            if (appData.budgets && Object.keys(appData.budgets).length > 0) {
                for (const category in appData.budgets) {
                    const budgetAmount = appData.budgets[category];
                    const budgetItemDiv = document.createElement('div');
                    budgetItemDiv.className = 'budget-item';
                    budgetItemDiv.innerHTML = `
                        <span class="category-name-col font-medium">${category}:</span>
                        <span class="budget-amount-col">${budgetAmount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó</span>
                    `;
                    setBudgetsList.appendChild(budgetItemDiv);
                }
            } else {
                setBudgetsList.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏Æ‡∏±‡∏ö! üòü</p>';
            }
        }

        // --- Event Handlers for Forms ---

        // Function to populate categories dropdown for transaction form based on selected type
        function populateCategories(type) {
            console.log("populateCategories called with type:", type);
            categorySelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>'; // Reset
            const categories = userCategories[type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'];
            if (categories && categories.length > 0) {
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.innerText = cat;
                    categorySelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.innerText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
                categorySelect.appendChild(option);
            }
        }

        // Handle type button clicks for transaction form (income/expense)
        typeButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                typeButtons.forEach(btn => btn.classList.remove('selected'));
                event.target.classList.add('selected');
                selectedTransactionType = event.target.dataset.type;
                populateCategories(selectedTransactionType);
            });
        });

        // Handle transaction form submission
        transactionForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const amount = parseFloat(amountInput.value);
            const detail = detailInput.value.trim();
            const category = categorySelect.value;

            if (!category) {
                showMessage('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! ü•∫', 'error');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showMessage('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! ü•∫', 'error');
                return;
            }

            const transaction = {
                action: 'add_transaction',
                payload: {
                    type: selectedTransactionType,
                    category: category,
                    amount: amount,
                    detail: detail || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', // Default detail if empty
                    date: new Date().toISOString() // Send current date as ISO string
                }
            };
            try {
                Telegram.WebApp.sendData(JSON.stringify(transaction));
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Æ‡∏±‡∏ö! ‚ú® (Mini App ‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)', 'success');
                transactionForm.reset();
                // Telegram.WebApp.close(); // Temporarily disabled for debugging, enable once confident
            } catch (e) {
                console.error("Error sending transaction data to bot:", e);
                showMessage("‡∏Æ‡∏∑‡∏≠‡πÜ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Æ‡∏±‡∏ö! üò≠", 'error');
            }
        });

        // Handle type button clicks for add category form
        newCatTypeIncomeBtn.addEventListener('click', () => {
            newCatTypeIncomeBtn.classList.add('selected');
            newCatTypeExpenseBtn.classList.remove('selected');
            selectedNewCategoryType = 'income';
        });
        newCatTypeExpenseBtn.addEventListener('click', () => {
            newCatTypeExpenseBtn.classList.add('selected');
            newCatTypeIncomeBtn.classList.remove('selected');
            selectedNewCategoryType = 'expense';
        });

        // Handle Add Category Form Submission
        addCategoryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const newCategoryName = newCategoryNameInput.value.trim();

            if (!newCategoryName) {
                showMessage("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! üìù", 'error');
                return;
            }

            const dataToSend = {
                action: 'add_category',
                payload: {
                    type: selectedNewCategoryType,
                    category_name: newCategoryName
                }
            };

            try {
                Telegram.WebApp.sendData(JSON.stringify(dataToSend));
                showMessage(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà '${newCategoryName}' ‡πÅ‡∏•‡πâ‡∏ß‡∏Æ‡∏±‡∏ö! ‚ú® (Mini App ‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)', 'success');
                addCategoryForm.reset();
                // Telegram.WebApp.close(); // Temporarily disabled for debugging, enable once confident
            } catch (e) {
                console.error("Error sending add category data to bot:", e);
                showMessage("‡∏Æ‡∏∑‡∏≠‡πÜ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Æ‡∏±‡∏ö! üò≠", 'error');
            }
        });

        // Handle Set Budget Form Submission
        setBudgetForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const category = budgetCategorySelect.value;
            const amount = parseFloat(budgetAmountInput.value);

            if (!category) {
                showMessage('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! ü•∫', 'error');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showMessage('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Æ‡∏±‡∏ö! ÔøΩ', 'error');
                return;
            }

            const budgetData = {
                action: 'set_budget',
                payload: {
                    category: category,
                    amount: amount
                }
            };
            try {
                Telegram.WebApp.sendData(JSON.stringify(budgetData));
                showMessage(`‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö '${category}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Æ‡∏±‡∏ö! ‚ú® (Mini App ‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)', 'success');
                setBudgetForm.reset();
                // Telegram.WebApp.close(); // Temporarily disabled for debugging, enable once confident
            } catch (e) {
                console.error("Error sending set budget data to bot:", e);
                showMessage("‡∏Æ‡∏∑‡∏≠‡πÜ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Æ‡∏±‡∏ö! üò≠", 'error');
            }
        });


        // --- Initial Load Logic ---
        // This function will be called once Telegram.WebApp is ready
        Telegram.WebApp.onEvent('mainButtonClicked', function() {
            // This is just an example. You might not need this if your app doesn't have a main button.
            // If you do, handle its logic here.
            console.log("Main button clicked!");
        });

        // Check if start_param exists and parse it
        function loadInitialData() {
            console.log("Attempting to load initial data...");
            let encodedData = null;

            // 1. Try to get start_param from Telegram.WebApp.initDataUnsafe
            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
                encodedData = Telegram.WebApp.initDataUnsafe.start_param;
                debugStartParamStatus.textContent = "Start Param Status: Received (via initDataUnsafe)";
                debugStartParamStatus.style.color = 'green';
                console.log("Encoded start_param (from initDataUnsafe):", encodedData);
            } else {
                console.log("No initial data (start_param) found in Telegram.WebApp.initDataUnsafe.");
                debugStartParamStatus.textContent = "Start Param Status: Not received (via initDataUnsafe)";
                debugStartParamStatus.style.color = 'red';

                // 2. Fallback: Try to get start_param directly from URL
                console.log("Current window.location.search:", window.location.search); // ADDED LOG
                const urlParams = new URLSearchParams(window.location.search);
                encodedData = urlParams.get('start_param');

                if (encodedData) {
                    debugStartParamStatus.textContent = "Start Param Status: Received (via URL)";
                    debugStartParamStatus.style.color = 'green';
                    console.log("Found start_param directly in URL:", encodedData);
                } else {
                    console.log("No initial data (start_param) found in URL either. This is unexpected if URL contains it.");
                    debugStartParamStatus.textContent = "Start Param Status: No start_param found anywhere";
                    debugStartParamStatus.style.color = 'orange';
                }
            }

            if (encodedData) {
                try {
                    // Replace '+' with ' ' before decoding, as decodeURIComponent doesn't handle '+' for space
                    const decodedData = decodeURIComponent(encodedData.replace(/\+/g, ' ')); 
                    console.log("Decoded data string:", decodedData);
                    
                    appData = JSON.parse(decodedData);
                    console.log("Parsed appData:", appData); // Log to console for debugging

                    debugDataParseStatus.textContent = "Data Parse Status: Success";
                    debugDataParseStatus.style.color = 'green';

                    // Update global categories
                    if (appData.categories) {
                        userCategories = appData.categories;
                        console.log("userCategories updated:", userCategories);
                    } else {
                        console.warn("appData.categories is missing or empty. Falling back to default.");
                        // Fallback to default categories if not provided
                        userCategories = { "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö": ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö)"], "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢": ["‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)"] };
                    }

                    // Initial rendering of the active page
                    showPage('add-transaction-page'); 

                } catch (e) {
                    console.error("Error parsing initial data:", e);
                    showMessage("‡∏Æ‡∏∑‡∏≠‡πÜ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Æ‡∏±‡∏ö! üò≠", 'error');
                    debugDataParseStatus.textContent = `Data Parse Status: Error (${e.message})`;
                    debugDataParseStatus.style.color = 'red';
                    // Fallback to render empty states if data parsing fails
                    renderDashboard();
                    renderSummaryAndBudgets();
                    renderManageCategories();
                    renderSetBudgetPage();
                    showPage('add-transaction-page'); 
                }
            } else {
                console.log("No encoded data to process. Rendering default empty states.");
                debugDataParseStatus.textContent = "Data Parse Status: No encoded data to process";
                debugDataParseStatus.style.color = 'orange';
                renderDashboard();
                renderSummaryAndBudgets();
                renderManageCategories();
                renderSetBudgetPage();
                showPage('add-transaction-page'); 
            }
        }

        // Call loadInitialData when the Telegram WebApp is ready
        // Using Telegram.WebApp.onEvent('ready', loadInitialData) as the primary trigger
        Telegram.WebApp.onEvent('ready', () => {
            // Add a small delay to ensure initDataUnsafe is fully populated
            setTimeout(loadInitialData, 50); // Try with a 50ms delay
        });
        // The immediate call to loadInitialData() is removed as it might fire too early.
        // loadInitialData(); // REMOVED THIS LINE
    </script>
</body>
</html>
ÔøΩ